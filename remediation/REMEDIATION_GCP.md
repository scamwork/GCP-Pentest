
# UNAUHENTICATED ENUM DEFENSE (SSRF) ðŸ›¡ï¸ðŸ›¡ï¸ðŸ›¡ï¸

SSRF vulnerability is a classic attack path for vulnerabilities related to Cloud infrastructures.

 ![SSRF]([https://raw.githubusercontent.com/SamuelGaudemer/GCP-Pentest/main/image/GCP%20PENTEST.png](https://www.vaadata.com/blog/wp-content/uploads/2018/05/SSRF-FR.jpg) "SSRF")
 
 Injetion a malicious URL into a vulnerable application in an input cal allow attacker to access local ressource, it allows attacker to bypass mesaures in place to protect internal systems and ressources.
 
 **Google Cloud Armor** can protect google cloud project.
 
 Possible to add rules in this **Google Cloud Armor** module to prevent attack. 
 
 ![GOOGLE CLOUD ARMOR](https://www.actuia.com/wp-content/uploads/2021/07/googlecloudarmor.jpg "Google Cloud Armor")

# STORAGE BUCKET (S3) SCOUT SUITE DEFENSE ðŸ›¡ï¸ðŸ›¡ï¸ðŸ›¡ï¸

Buckets store all data and have to be protected to prevent information leak and motivate attacker. 

[**SCOUTSUITE**](https://github.com/nccgroup/ScoutSuite) open source security tool. [**SCOUT SUITE**](https://github.com/nccgroup/ScoutSuite) audit the solution and display the vulnerabilities.

![SCOUTE SUITE](https://ia802801.us.archive.org/7/items/github.com-nccgroup-ScoutSuite_-_2019-12-28_21-14-35/cover.jpg)
```
$ virtualenv -p python3 env
$ source venv/bin/activate
$ pip install scoutsuite
$ scout --help
$ scout gcp --user-account --project-id GCP-PROJECT-ID
```

Can detect that bucket is accessible in public access with misconfigured policy, suggest you to prevent public access to a sensible bucket and fix roles & permission to prevent vulnerabilities (only authorize get request instead of get & set).


# PRIVILEGE ESCLATION DEFENSE ðŸ›¡ï¸ðŸ›¡ï¸ðŸ›¡ï¸ 

## POLICY ANALYZER

**Policy Analyzer a native GCP (Google Cloud Platform)** "is a tool wich lets you find out which principales have access to wich ressource based on IAM policy."

**Review IAM policy & Roles** to prevent unwanted access to a sensible ressource.

Tutorial => https://www.youtube.com/watch?v=4qJg_fuzMBI

## CLOUD CUSTODIAN POLICY 

"By granting a service account too many privileges, an attacker who gains control of the service account can potentially compromise all resources in the associated project."

Install Cloud Custodian the the local GCP VM to manage GCP ressources : 
in the machine :
```
$ python3 -m venv custodian
$ source custodian/bin/activate
$ pip install c7n_gcp
$ gcloud auth application-default login
```
create policy file :

```
policies:
  - name: vm-access-control-policy
    description: |
      Shuts down any compute instances that have too many privileges.
    resource: gcp.instance
    filters:
      - or:
        - type: value
          key: serviceAccounts[*].scopes[]
          op: contains
          value: https://www.googleapis.com/auth/cloud-platform
        - type: value
          key: serviceAccounts[*].scopes[]
          op: contains
          value: https://www.googleapis.com/auth/compute
    actions:
      - type: stop
      - type: notify
        subject: Stopped Instance having over privilage scopes
        to:
          - gcpgoat@ine.com
        transport:
          type: pubsub
          topic: projects/gcp-goat-c35c296a27d9e2fe/topics/notification-handler-topic
```
- execute the policy with : 
```
$ GOOGLE_CLOUD_PROJECT="<Your project ID>" custodian run --output-dir=. policy.yml
$ cat vm-access-control-policy/resources.json
```
The excessive scopies issue in the VM has been successfully addressed.

https://cloudcustodian.io/

Ressource : https://github.com/ine-labs/GCPGoat/blob/main/defence-manuals/03-Defending%20Privilege%20Escalations%201.md
